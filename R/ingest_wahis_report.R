#' Support function for ingest_wahis_report to find table in report
#' @param page output of read_xml
#' @param pref th = colnames; td = table header ?
#' @param header_name string to match when searching colnames or table headers
#' @noRd
find_parent <- function(page, pref, header_name){
    
    tbl_header_xml <- paste0('//', pref, '[contains(., "',
                             header_name,
                             '")]')
    
    tab_title <- xml_find_all(page, tbl_header_xml)
    parent <- xml_parents(tab_title)
    
    parent <- switch(pref,
                  "th" = parent[which(xml_name(parent) == "table")],
                  "td" = parent[[min(which(xml_name(parent) == "table"))]])

    return(parent)
}


#' Support function for ingest_wahis_report to clean html tables
#' @param parents generated by find_parent
#' @noRd
clean_oie_report_table <- function(parent){
    
    tbl_out <- parent %>% 
        html_table() %>%
        as_tibble() %>%
        set_names(.[2,]) %>%
        clean_names() %>%
        slice(-1:-2) %>%
        mutate_all(~na_if(., "")) 
    return(tbl_out)
}

#' Extract Info from WAHIS Annual and Semi-Annual Reports
#'
#' Extract the information found in the Annual and Semi-Annual OIE World Animal Health Information
#' System (WAHIS) HTML reports. These reports have to be provided to this function.
#'
#' @param web_page Name of the downloaded web page
#'
#' @return A list with elements:
#' \item{id}{Record id.}
#' \item{diseases_present}{Table of disease present in country over time period}
#' @examples
#' ##ingest_wahis_report("../data-raw/raw_wahis_reports/BWA_2016_sem0.html")
#' @export
#' @importFrom xml2 read_xml xml_find_first xml_text xml_parents
#' @importFrom stringi stri_extract_first_regex
#' @importFrom stringr str_remove str_trim
#' @importFrom rvest html_table
#' @importFrom purrr map_df
#' @importFrom tidyr fill
#' @importFrom magrittr set_names
#' @importFrom janitor clean_names
#' @import dplyr

ingest_wahis_report <- function(web_page) {
    
    # get page
    page <- suppressWarnings(read_xml(web_page, as_html = TRUE, options = c("RECOVER", "NOERROR", 
                                                                            "NOBLANKS")))
    # get country name
    country <- xml_find_first(page, '//td[contains(., "Country:")]') %>% xml_text() %>% stri_extract_first_regex("(?<=:\\s).*")
    
    # get report period
    report_period <- xml_find_first(page, '//td[contains(., "Report period:")]') %>% xml_text() %>% stri_extract_first_regex("(?<=:\\s).*")
    
    ## 1
    # OIE-listed diseases/infections present
    parent <- find_parent(page, "td", "Summary on OIE-listed diseases/infections present in")
    diseases_present <- clean_oie_report_table(parent) %>%
        fill(oie_listed_disease, .direction = "down") %>% 
        group_by(oie_listed_disease) %>%
        mutate(oie_listed_disease_row_id = row_number()) %>%
        ungroup()
    
    # get notes into OIE listed disease table
    note_rows <- which(stri_detect_fixed(diseases_present$oie_listed_disease, "note", case_insensitive = TRUE))
    notes <- tibble(oie_listed_disease = diseases_present$oie_listed_disease[note_rows - 1],
                    oie_listed_disease_row_id = 1,
                    notes = diseases_present$oie_listed_disease[note_rows])
    
    if(length(note_rows)) {
        diseases_present <- diseases_present %>%
            slice(-note_rows) %>%
            left_join(notes, by = c("oie_listed_disease", "oie_listed_disease_row_id")) %>%
            select(-oie_listed_disease_row_id)
    }else{
        diseases_present$notes <- NA_character_
    }
    
    ## 2
    # OIE-listed diseases absent
    parent <- find_parent(page, "th", "Date of last occurrence")
    diseases_absent <- map_df(parent, ~clean_oie_report_table(.))

    ## 3  
    # Detailed quantitative information for OIE-listed diseases/infections present
    # Disease information by State by month
    #TODO ^ this might be different for pre-2014
    
    parent <- find_parent(page, "th", "Month")
    
    #TODO how to do this with purrr (ie using single bracket subset)?
    diseases_present_detail <- tibble()
    for(i in seq_along(parent)){
        
        p_node <- parent[[i]]
        disease <- html_table(p_node)[1,1] 
        disease_check <- str_remove(disease, "Species") %>% str_trim()
        
        if(disease_check %in% c("Wild", "Domestic")){ #TODO need to test this on other cases
            p_nodeset <- parent[i]
            grandparent <- xml_parent(p_nodeset) # get parent of table
            siblings <- xml_children(grandparent) 
            disease <- siblings[which(siblings %in% p_nodeset)-1] %>% html_text()
        }
        
        diseases_present_detail <- bind_rows(diseases_present_detail, 
                                             clean_oie_report_table(p_node) %>%
                                                 fill(month, .direction = "down") %>%
                                                 mutate(disease = disease)) #TODO note that these output diseases do not exactly match the disease_present diseases because of line breaks
    }
    
    ## 4  
    # Unreported OIE-listed diseases during the reporting period
    
    ## 5  
    # Zoonotic diseases in humans
    parent <- find_parent(page, "td", "Zoonotic diseases in humans")
    disease_humans <- clean_oie_report_table(parent) 

    ## 6
    # Animal population
    parent <- find_parent(page, "td", "Animal population")
    animal_population <- clean_oie_report_table(parent) 
    
    ## 7
    # Veterinarians and veterinary para-professionals
    
    ## 8
    #  National reference laboratories
    parent <- find_parent(page, "td", "National reference laboratories")
    national_reference_laboratories <- clean_oie_report_table(parent) 
    
    ## 9
    # Diagnostic Tests
    parent <- find_parent(page, "td", "Diagnostic Tests")
    national_reference_laboratories_detail <- clean_oie_report_table(parent) %>%
        fill(laboratory, .direction = "down") %>%
        fill(disease, .direction = "down")
    
    ## 10
    # Vaccine Manufacturers
    parent <- find_parent(page, "td", "Vaccine Manufacturers")
    vaccine_manufacturers <- clean_oie_report_table(parent) 

    ## 11
    # Vaccines
    parent <- find_parent(page, "td", "Vaccines")
    vaccine_manufacturers_detail <- clean_oie_report_table(parent) %>%
        fill(disease, .direction = "down")
    
    # output
    return(list(
        "country" = country,
        "report_period" = report_period,
        "web_page" = web_page,
        "diseases_present"= diseases_present, 
        "diseases_absent"= diseases_absent,
        "diseases_present_detail"= diseases_present_detail,
        "disease_humans" = disease_humans,
        "animal_population" = animal_population,
        "national_reference_laboratories" = national_reference_laboratories,
        "national_reference_laboratories_detail" = national_reference_laboratories_detail,
        "vaccine_manufacturers" = vaccine_manufacturers,
        "vaccine_manufacturers_detail" = vaccine_manufacturers_detail))
}

safe_ingest <- function(web_page) {
    out <- safely(ingest_wahis_report)(web_page)
    if(!is.null(out$result)) {
        return(out$result)
    } else {
        return(tibble(file = basename(web_page)))
    }
}

